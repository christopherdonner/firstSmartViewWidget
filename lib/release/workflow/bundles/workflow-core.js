csui.define("workflow/models/workitem/workitem.model",["csui/lib/backbone","csui/utils/url","csui/utils/base","csui/lib/underscore","csui/lib/jquery","csui/utils/contexts/factories/connector"],function(t,e,o,s,i,r){var n=t.Model.extend({"defaults":{"id":"","key":"","label":"","custom":!1},"constructor":function(){t.Model.prototype.constructor.apply(this,arguments)},"parse":function(t,e){var o=t.key,s=t.label,i=e.custom?"custom-"+o:"standard-"+o;return{"key":o,"label":s,"id":i,"custom":e.custom}}}),c=t.Collection.extend({"model":n,"constructor":function(){t.Collection.prototype.constructor.apply(this,arguments)}}),a=t.Model.extend({"constructor":function(){t.Model.prototype.constructor.apply(this,arguments)},"_saveChanges":function(t,n){var c=n.options.context.getObject(r),a=c.connection.url.replace("/v1","/v2"),d=n.alpaca.options.form.attributes.action.split("v1"),l=e.combine(a,d[1]),u=i.Deferred(),f=!0;return"create"===n.mode&&(f=!1),i.ajax(c.extendAjaxOptions({"type":"PUT","url":l,"async":f,"data":{"body":JSON.stringify(t)}})).done(s.bind(function(){u.resolve()},this)).fail(s.bind(function(t){var e=new o.Error(t);u.reject(e)},this)),u}}),d=t.Collection.extend({"model":a,"constructor":function(){t.Collection.prototype.constructor.apply(this,arguments)}}),l=t.Model.extend({"defaults":{"process_id":0,"subprocess_id":0,"task_id":0,"isDraft":!1,"title":"","instructions":"","doc_id":0,"mapsList":[]},"constructor":function(e,o){t.Model.prototype.constructor.apply(this,arguments),o&&o.connector&&o.connector.assignTo(this)},"url":function(){var t=this.connector.connection.url,o=this.get("isDraft"),s=this.get("mapsList"),i=this.get("draft_id"),r=i?i:this.get("process_id");return o||this.get("isDocDraft")||s&&1===s.length?e.combine(t,"/forms/draftprocesses/update?draftprocess_id="+r):e.combine(t,"/forms/processes/tasks/update?process_id="+this.get("process_id")+"&subprocess_id="+this.get("subprocess_id")+"&task_id="+this.get("task_id"))},"parse":function(t){return this.forms=new d(t.forms),this.actions=new c(t.data.actions,{"parse":!0,"custom":!1}),delete t.data.actions,this.customActions=new c(t.data.custom_actions,{"parse":!0,"custom":!0}),delete t.data.custom_actions,t.data},"isFetchable":function(){var t=this.get("doc_id");return t?t:!!this.get("process_id")},"reset":function(t){this.clear(t),s.isUndefined(this.actions)||this.actions.reset(),s.isUndefined(this.customActions)||this.customActions.reset(),s.isUndefined(this.forms)||this.forms.reset()},"title":function(){return this.get("title")},"sendAction":function(t){var o=this.connector.connection.url.replace("/v1","/v2"),r=e.combine(o,"processes",this.get("process_id"),"subprocesses",this.get("subprocess_id"),"tasks",this.get("task_id")),n=i.Deferred(),c=this.get("isDraft"),a=this.get("mapsList"),d=this.get("draft_id"),l=d?d:this.get("process_id");(c||this.get("isDocDraft")||a&&1===a.length)&&(r=e.combine(o,"draftprocesses",l));var u={};t.get("custom")?u.custom_action=t.get("key"):u.action=t.get("key"),void 0!==this.get("comment")&&this.get("comment").length>0&&(u.comment=this.get("comment")),"Delegate"===t.get("key")&&(u.assignee=this.get("assignee").toString()),"Review"===t.get("key")&&(u.assignee=this.get("assignee").toString(),u.assigneeOption=s.isNumber(this.get("assigneeOption"))?this.get("assigneeOption").toString():"0"),this.get("authentication")===!0&&(u.authentication_info=this.get("authentication_info"));var f=new FormData;f.append("body",JSON.stringify(u));var p={"type":"PUT","url":r,"data":f,"contentType":!1,"processData":!1};return this.connector&&this.connector.extendAjaxOptions(p),i.ajax(p).done(s.bind(function(t){n.resolve(t.results),this.trigger("workitem:sendon")},this)).fail(s.bind(function(t){n.reject(t)},this)),n},"sendMemberAcceptAction":function(t){var o=this.connector.connection.url.replace("/v1","/v2"),r=e.combine(o,"processes",this.get("process_id"),"subprocesses",this.get("subprocess_id"),"tasks",this.get("task_id"));t=t?t:"accept";var n={"action":t},c=new FormData,a=i.Deferred();c.append("body",JSON.stringify(n));var d={"type":"PUT","url":r,"data":c,"contentType":!1,"processData":!1};return this.connector&&this.connector.extendAjaxOptions(d),i.ajax(d).done(s.bind(function(){a.resolve()},this)).fail(s.bind(function(t){var e=JSON.parse(t.responseText);a.reject(e)},this)),a}});return l}),csui.define("workflow/models/workflow/workflow.model",["csui/lib/backbone","csui/utils/url","csui/utils/base","csui/lib/underscore","csui/lib/jquery","csui/utils/contexts/factories/connector"],function(t,e,o,s,i){var r=t.Model.extend({"defaults":{"workflow_id":0},"constructor":function(e,o){t.Model.prototype.constructor.apply(this,arguments),o&&o.connector&&o.connector.assignTo(this)},"createDraftProcess":function(){var t=this.connector.connection.url.replace("/v1","/v2"),o=e.combine(t,"draftprocesses"),r={"workflow_id":this.get("workflow_id"),"doc_ids":this.get("DocIDs")},n=new FormData,c=i.Deferred();n.append("body",JSON.stringify(r));var a={"type":"POST","url":o,"data":n,"contentType":!1,"processData":!1};return this.connector&&this.connector.extendAjaxOptions(a),i.ajax(a).done(s.bind(function(t){c.resolve(t.results)},this)).fail(s.bind(function(t){c.reject(t.responseJSON.error)},this)),c},"getDocumentWorkflows":function(){var t=function(t){var e="",o=t.doc_id?t.doc_id.split(","):t.DocIDs,r=i("#selectionID");if(s.each(o,function(t){e=e.concat("doc_id").concat("=").concat(t).concat("&")}),t.ParentID&&(e=e.concat("parent_id=").concat(t.ParentID)),t.checkEnabled&&(e=e.concat("&checkEnabled=").concat(t.checkEnabled)),0===r.length){var n=i("#tableview tbody>tr")[0];n&&(i("<input>").attr({"type":"hidden","id":"selectionID","value":s.uniqueId()}).appendTo(n),r=i("#selectionID"))}return r.val()&&(e=e.concat("&selectionID=").concat(r.val())),t.newDocID&&s.each(t.newDocID,function(t){e=e.concat("&newDocID").concat("=").concat(t)}),e},o=this.connector.connection.url.replace("/v1","/v2"),r=e.combine(o,"docworkflows?"+t(this.attributes)),n=i.Deferred(),c={"type":"GET","url":r,"async":this.get("CheckEnable")?!1:!0};return this.connector&&this.connector.extendAjaxOptions(c),i.ajax(c).done(s.bind(function(t){this.get("CheckEnable")?n.resolve(t.results):1===t.results.data.length?(this.set("workflow_id",t.results.data[0].DataID),this.set("resp",t.results),this.createDraftProcess().done(s.bind(function(t){var e=this.get("resp");e.data[0].draftprocess_id=t.draftprocess_id,n.resolve(e)},this)).fail(s.bind(function(t){n.reject(t)},this))):n.resolve(t.results)},this)).fail(s.bind(function(t){n.reject(t)},this)),n}});return r}),csui.define("workflow/models/workitem/workitem.model.factory",["csui/lib/jquery","csui/lib/underscore","csui/utils/contexts/factories/factory","csui/utils/contexts/factories/connector","workflow/models/workitem/workitem.model","workflow/models/workflow/workflow.model"],function(t,e,o,s,i,r){var n=o.extend({"propertyPrefix":"workitem","constructor":function(t,e){o.prototype.constructor.apply(this,arguments);var n=t.getObject(s,e);this.context=t,this.property=new i(void 0,{"connector":n}),this.workflow=new r(void 0,{"connector":n})},"isFetchable":function(){return this.property.isFetchable()},"fetch":function(o){var s=this.property.get("isDoc"),i=this.property.get("mapsList"),r=t.Deferred();if(!s||this.property.get("process_id")||this.property.get("draft_id")){if(this.property.get("isDocDraft")){var n=this.property.fetch({"silent":!0});return n.done(e.bind(function(){this.workflow.set("doc_id",this.property.get("doc_id")),this.workflow.set("ParentID",this.property.get("parent_id")),this.workflow.getDocumentWorkflows().done(e.bind(function(t){this.property.set({"datafetched":!0},{"silent":!0}),this.property.set("mapsList",t.data),r.resolve(this.property)},this)).fail(e.bind(function(t){r.reject(t)},this))},this)).fail(e.bind(function(t){r.reject(t)},this)),r.promise()}return this.property.fetch(o)}return i&&i.length>0?r.resolve(this.property):(this.workflow.set("doc_id",this.property.get("doc_id")),this.workflow.set("ParentID",this.property.get("parent_id")),this.workflow.getDocumentWorkflows().done(e.bind(function(t){this.property.set({"datafetched":!0},{"silent":!0}),this.property.set("mapsList",t.data),r.resolve(this.property)},this)).fail(e.bind(function(t){r.reject(t)},this)),r.promise())}});return n}),csui.define("workflow/commands/defaultactionitems",[],function(){return[{"equals":{"type":[128]},"signature":"InitiateWorkflow","sequence":30},{"equals":{"type":[153]},"signature":"OpenWorkflowStep","sequence":30}]}),csui.define("workflow/commands/initiate.workflow/initiate.workflow",["csui/lib/jquery","csui/lib/underscore","csui/utils/commandhelper","csui/utils/commands/open.classic.page","workflow/models/workitem/workitem.model.factory","workflow/models/workflow/workflow.model"],function(t,e,o,s,i,r){var n,c,a=s.extend({"defaults":{"signature":"InitiateWorkflow","command_key":["initiateworkflow"],"scope":"single"},"execute":function(s,a){var d=o.getJustOneNode(s),l=t.Deferred(),u=d.actions.get(this.get("command_key")[0]);if(u&&"initiate_in_smartview"===u.get("body"))return csui.require(["csui/controls/globalmessage/globalmessage","csui/utils/contexts/factories/connector"],function(){n=arguments[0],c=arguments[1],a=a||{};var t=s.context||a&&a.context,o=t.getObject(c,a),u=new r({"workflow_id":d.get("id"),"DocIDs":s.doc_id},e.extend(a,{"connector":o}));u.createDraftProcess().done(e.bind(function(e){var o=t.getModel(i);if(s.isDoc===!0){var r={};r.isDocDraft=!0,r.docModels=s.docModel,r.parent_id=s.parent_id,r.status=s,r.draft_id=e.draftprocess_id,o.set(r,{"silent":!0}),o.set("doc_id",s.doc_id),o.set("doc_names",s.docNames)}else o.set("isDraft",!0),o.set("process_id",e.draftprocess_id)},this)).fail(e.bind(function(t){n.showMessage("error",t),l.reject()},this))},function(t){l.reject(t)}),l;var f=s.context||a&&a.context,p=f.getModel(i);return a=a||{},p.set("isDoc",s.isDoc),p.set("parent_id",s.parent_id),p.set("doc_id",s.doc_id),p.set("doc_names",s.docNames),s.isDoc===!0&&(a.isDoc=!0,a.doc_id=s.doc_id,a.parent_id=s.parent_id,a.doc_names=s.docNames,a.connector=p.connector),this._navigateTo(d,a)},"getUrlQueryParameters":function(e,o){var s;if(o.isDoc===!0){var i={},r=o.connector.connection.url.replace("/api/v1","");i.func="wfinitiation.InitiateWorkflowMap",i.ParentID=o.parent_id,i.DocNames=o.doc_names,i.WFMapsDataID=e.get("id"),i.nexturl=r+"/app/nodes/"+i.ParentID,s=t.param(i);var n=o.doc_id.split(",");for(var c in n)s+="&DocID=".concat(n[c])}else s={},s.func="ll",s.objAction="Initiate",s.objId=e.get("id"),s.nexturl=location.href;return s}});return a}),csui.define("workflow/commands/initiate.document.workflow/initiate.document.workflow",["csui/lib/jquery","csui/lib/underscore","csui/utils/commandhelper","csui/utils/commands/open.classic.page","csui/models/node/node.model","csui/controls/globalmessage/globalmessage","workflow/models/workitem/workitem.model.factory","workflow/models/workflow/workflow.model"],function(t,e,o,s,i,r,n,c){var a,d,l=s.extend({"defaults":{"signature":"InitiateDocumentWorkflow","command_key":["initiatedocumentworkflow"],"scope":"multiple"},"hasCommonWorkflows":function(t){for(var o=t.length,s=0,i=t[0].length;i>s;s++){var r,n=t[0][s];for(r=1;o>r&&e.contains(t[r],n);r++);if(r===o)return!0}return!1},"enabled":function(e){if(!e.container||t("csui-expanded.cs-dialog").length>0)return!1;var s=this.get("command_key"),i=o.getAtLeastOneNode(e).models,r=!1;if(!this._checkPermittedActions(i,s,e.container))return!1;for(var n=0;n<i.length;n++)if((1!==i.length||!i[n].get("csuiLazyActionsRetrieved")&&!i[0].isLocallyCreated)&&!i[n].get("csuiIsSelected"))return!1;var c,a=[];if(1===i.length)c=i[0].actions.get("initiatedocumentworkflow").get("wfList"),c&&(r=c.length>0?!0:!1);else if(i.length>1){for(var d=0;d<i.length;d++){if(c=i[d].actions.get("initiatedocumentworkflow").get("wfList"),!(c&&c.length>0))return!1;r=!0,a.push(c)}return r?this.hasCommonWorkflows(a):!1}return r},"getDocIds":function(t){var o=[];return e.each(t,function(t){o.push(t.get("id"))}),o},"getDocNames":function(t){var o={};return e.each(t,function(t){o[t.get("id")]=t.get("name")}),o},"getDelimitedString":function(t,o){var s="",i="";return e.each(t,function(t){s=s.concat(i).concat(t),i=o}),s},"getCommonWorkflows":function(o,s){var i=t.Deferred(),r=o.container.connector,n=this.get("scope"),a=s||{},d=this._getNodesByScope(o,n),l=new c({"CheckEnable":!0},e.extend(a,{"connector":r})),u=this.getDocIds(d);l.set("DocIDs",u),l.set("ParentID",o.container.attributes.id),l.set("checkEnabled",s.checkEnabled);var f=this.get("prevNodeSelection");if(f){var p=e.filter(u,function(t){return!e.contains(f,t)});u.length>f.length&&t(u).filter(f).length===f.length?l.set("newDocID",p):(u.length<f.length||1===u.length&&u.length===f.length&&u[0]!==f[0])&&t("#selectionID").length>0&&t("#selectionID").remove()}return l.getDocumentWorkflows().done(e.bind(function(t){this.set("prevEnabledNodeLen",d.length),this.set("prevNodeSelection",u),t.data.length>0?i.resolve():i.reject()},this)).fail(e.bind(function(){this.set("prevEnabledNodeLen",d.length),this.set("prevNodeSelection",u),i.reject()},this)),i.promise()},"execute":function(s,l){var u=o.getAtLeastOneNode(s).models,f=s.container.attributes.id,p=t.Deferred(),h=this,w=this.getDocIds(u),m=this.getDocNames(u),g={"DocIDs":w,"ParentID":f},k=this.getDelimitedString(w,",");return csui.require(["csui/utils/contexts/factories/connector","csui/utils/contexts/factories/node"],function(){a=arguments[0],d=arguments[1],l=l||{};var t=s.context||l&&l.context,o=t.getObject(a,l),w=new c(g,e.extend(l,{"connector":o}));w.getDocumentWorkflows().done(e.bind(function(c){if(c.statusMsg)r.showMessage("error",c.statusMsg),p.reject();else{var a=[];e.each(u,function(t){var e=new i({"type":1,"type_name":"Shortcut","container":!1,"name":t.attributes.name,"original_id":t.attributes.id,"original_id_expand":t.attributes},{"connector":o});a.push(e)});var w=t.getModel(n);if(w.set("isDoc",!0),w.set("docModels",a),w.set("mapsList",c.data),w.set("datafetched",!0),w.set("parent_id",f),w.set("status",s),1===c.data.length){var g=t.getModel(d,{"attributes":{"id":c.data[0].DataID}});g.fetch().done(e.bind(function(){var t=g.actions.get("initiateworkflow");return t&&"initiate_in_smartview"===t.get("body")?(w.set("draft_id",c.data[0].draftprocess_id),w.set("doc_id",k),w.set("doc_names",m),void 0):(l.isDoc=!0,l.doc_id=k,l.doc_names=m,l.parent_id=f,h._navigateTo(g,l))},this)).fail(e.bind(function(t){t.responseJSON&&r.showMessage("error",t.responseJSON.error)},this))}else w.set("doc_id",k),w.set("doc_names",m)}},this)).fail(e.bind(function(t){t.responseJSON&&r.showMessage("error",t.responseJSON.error),p.reject()},this))},function(t){p.reject(t)}),p},"getUrlQueryParameters":function(e,o){var s;if(o.isDoc===!0){var i={},r=o.connector.connection.url.replace("/api/v1","");i.func="wfinitiation.InitiateWorkflowMap",i.ParentID=o.parent_id,i.DocNames=o.doc_names,i.WFMapsDataID=e.get("id"),i.nexturl=r+"/app/nodes/"+i.ParentID,s=t.param(i);var n=o.doc_id.split(",");for(var c in n)s+="&DocID=".concat(n[c])}else s={},s.func="ll",s.objAction="Initiate",s.objId=e.get("id"),s.nexturl=location.href;return s}});return l}),csui.define("workflow/commands/open.workitem/open.workitem",["csui/lib/underscore","csui/lib/jquery","csui/utils/commandhelper","csui/utils/commands/open.classic.page","csui/utils/command.error","csui/utils/contexts/factories/connector","workflow/models/workitem/workitem.model.factory"],function(t,e,o,s,i,r,n){var c=s.extend({"defaults":{"signature":"OpenWorkflowStep"},"enabled":function(t){var e=o.getJustOneNode(t);return e&&153===e.get("type")},"execute":function(t,s){var i=o.getJustOneNode(t);if(i.get("workflow_open_in_smart_ui")){s=s||{};var r=t.context||s&&s.context,c=e.Deferred(),a=r.getModel(n);return a.set({"process_id":i.get("workflow_id"),"subprocess_id":i.get("workflow_subworkflow_id"),"task_id":i.get("workflow_subworkflow_task_id"),"url_org":location.href}),c}return this._navigateTo(i,s)},"getUrlQueryParameters":function(t){return{"func":"work.EditTask","workid":t.get("workflow_id"),"subworkid":t.get("workflow_subworkflow_id"),"taskid":t.get("workflow_subworkflow_task_id"),"nexturl":location.href}}});return c}),csui.define("workflow/perspective/routers/workflow.perspective.router",["csui/pages/start/perspective.router","csui/utils/contexts/factories/application.scope.factory","workflow/models/workitem/workitem.model.factory"],function(t,e,o){var s=t.extend({"routes":{"processes/:process_id/:subprocess_id/:task_id":"openProcess","draftprocesses/:draftprocess_id":"openDraftProcess","docworkflows/:doc_id/:parent_id":"openDocumentProcess","docworkflows/:doc_id/:parent_id/draftprocesses/:draftprocess_id":"openDocumentDraftProcess"},"constructor":function(){t.prototype.constructor.apply(this,arguments),this.applicationScope=this.context.getModel(e),this.workItem=this.context.getModel(o),this.listenTo(this.workItem,"change:process_id",this._updateUrl),this.listenTo(this.workItem,"change:doc_id",this._updateUrl)},"openProcess":function(t,e,o){this.workItem.set({"process_id":parseInt(t),"subprocess_id":parseInt(e),"task_id":parseInt(o),"isDraft":!1})},"openDraftProcess":function(t){this.workItem.set({"process_id":parseInt(t),"isDraft":!0})},"openDocumentProcess":function(t,e){var o=this.workItem.defaults;this.workItem.reset({"silent":!0}),this.workItem.set(o,{"silent":!0}),this.workItem.set({"parent_id":parseInt(e),"isDoc":!0,"doc_id":t})},"openDocumentDraftProcess":function(t,e,o){this.workItem.set({"parent_id":parseInt(e),"draft_id":parseInt(o),"isDocDraft":!0,"doc_id":t})},"onOtherRoute":function(){this.workItem.reset({"silent":!0})},"_updateUrl":function(){var t=this.workItem.get("process_id"),e=this.workItem.get("subprocess_id"),o=this.workItem.get("task_id"),s=this.workItem.get("isDraft"),i=this.workItem.get("isDocDraft"),r=this.workItem.get("isDoc"),n=this.workItem.get("mapsList"),c=this.workItem.get("doc_id"),a=this.workItem.get("parent_id"),d=this.workItem.get("draft_id");if(!(t&&c||!c&&!t&&"workflow"!==this.applicationScope.id)){var l="processes";s?(l="draftprocesses",t&&(l+="/"+t)):i||n&&1===n.length?(l="docworkflows",c&&a&&d&&(l+="/"+c+"/"+a+"/draftprocesses/"+d)):r?(l="docworkflows",c&&a&&(l+="/"+c+"/"+a)):(l="processes",t&&(l+="/"+t+"/"+e+"/"+o)),this.navigate(l)}}});return s}),csui.define("bundles/workflow-core",["workflow/models/workitem/workitem.model.factory","workflow/commands/defaultactionitems","workflow/commands/initiate.workflow/initiate.workflow","workflow/commands/initiate.document.workflow/initiate.document.workflow","workflow/commands/open.workitem/open.workitem","workflow/perspective/routers/workflow.perspective.router"],{});
//# sourceMappingURL=workflow-core.js.map